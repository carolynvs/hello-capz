# This is the configuration for Porter
# You must define steps for each action, but the rest is optional
# See https://porter.sh/author-bundles for documentation on how to configure your bundle
# Uncomment out the sections below to take full advantage of what Porter can do!

name: capz-hello
version: 0.1.0
description: "An example Porter configuration"
# TODO: update the registry to your own, e.g. myregistry
registry: ghcr.io/squillace

# If you want to customize the Dockerfile in use, uncomment the line below and update the referenced file. 
# See https://porter.sh/custom-dockerfile/
#dockerfile: Dockerfile.tmpl

mixins:
  - exec
  - capz

install:
#export AZURE_SUBSCRIPTION_ID_B64="$(echo -n "$AZURE_SUBSCRIPTION_ID" | base64 | tr -d '\n')"
#export AZURE_TENANT_ID_B64="$(echo -n "$AZURE_TENANT_ID" | base64 | tr -d '\n')"
#export AZURE_CLIENT_ID_B64="$(echo -n "$AZURE_CLIENT_ID" | base64 | tr -d '\n')"
#export AZURE_CLIENT_SECRET_B64="$(echo -n "$AZURE_CLIENT_SECRET" | base64 | tr -d '\n')"
  - exec:
      command: bash
      description: ""
      suppress-output: false
      flags:
        c: "'env'"

  - exec:
      command: bash
      description: "Encoding parameters to base64..."
      suppress-output: true
      flags:
        c: "'echo -n {{bundle.credentials.AZURE_SUBSCRIPTION_ID}} | base64'"
      outputs:
        - name: AZURE_SUBSCRIPTION_ID_B64
          regex: "(.*)"
          env: "AZURE_SUBSCRIPTION_ID_B64"
  - exec:
      command: bash
      description: "Encoding parameters to base64..."
      suppress-output: true
      flags:
        c: "'echo -n {{bundle.credentials.AZURE_TENANT_ID}} | base64'"
      outputs:
        - name: AZURE_TENANT_ID_B64
          regex: "(.*)"
  - exec:
      command: bash
      description: "Encoding parameters to base64..."
      suppress-output: true
      flags:
        c: "'echo -n {{bundle.credentials.AZURE_CLIENT_ID}} | base64'"
      outputs:
        - name: AZURE_CLIENT_ID_B64
          regex: "(.*)"
  - exec:
      command: bash
      description: "Encoding parameters to base64..."
      suppress-output: true
      flags:
        c: "'echo -n {{bundle.credentials.AZURE_CLIENT_SECRET}} | base64'"
      outputs:
        - name: AZURE_CLIENT_SECRET_B64
          regex: "(.*)"
  - capz:
      description: "Installing Cluster API into the cluster...."
      arguments:
        - "version" # "init"
#      flags:
#        infrastructure: "azure"
  - exec:
      command: bash
      description: ""
      suppress-output: false
      flags:
        c: "'env'"
upgrade:
  - exec:
      description: "World 2.0"
      command: ./helpers.sh
      arguments:
        - upgrade

uninstall:
  - capz:
      description: "Uninstalling the management control plane from the cluster..."
      arguments:
        - "delete"
      flags:
        infrastructure: "azure"
        include-crd: ""
        include-namespace: ""


# Below is an example of how to define credentials
# See https://porter.sh/author-bundles/#credentials
credentials:
  - name: kubeconfig
    path: /root/.kube/config
  - name: AZURE_SUBSCRIPTION_ID
    env: AZURE_SUBSCRIPTION_ID
    type: string
    description: "The Azure subscription id"
  - name: AZURE_TENANT_ID
    env: AZURE_TENANT_ID
    type: string
    description: "The Azure tenant id"
  - name: AZURE_CLIENT_ID
    env: AZURE_CLIENT_ID
    type: string
    description: "The Azure client or app id"
  - name: AZURE_CLIENT_SECRET
    env: AZURE_CLIENT_SECRET
    type: string
    description: "The Azure app password or secret"  
  - name: AZURE_ENVIRONMENT
    env: AZURE_ENVIRONMENT
    default: AzurePublicCloud
    type: string
    description: "The Azure cloud environment into which to deploy"
#  - name: username
#    env: USERNAME

# Below is an example of how to define parameters
# See https://porter.sh/author-bundles/#parameters



